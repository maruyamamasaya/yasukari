# yasukari
Next.jsで構築しているレンタルバイクサービス **yasukari** の公式サイトリポジトリです。更新履歴や各種ドキュメントは `manual_for_system` と `docs` ディレクトリで管理しています。

yasukari公式ホームページリニューアル

## 変更履歴

バージョンは0.1から開始し、軽微な修正は0.01刻み、主な修正では0.1刻みで更新します。開発中のため先頭に0を付けた表記です。

### v0.50
- Next.js による初期構築
- トップページのUI/UX設計・開発
- BikeModelCarousel コンポーネント追加
- Footer コンポーネント追加
- グローバルスタイルとアニメーションを導入

### v0.51
- ChatBotWidget 追加でどのページからでもチャットを起動可能に
- ManualページにCalendarWidgetとDirectoryTreeを表示
- ホーム画面をモダンなレイアウトへ刷新
- 商品一覧ページ(仮)を追加
- スタイル調整とリファクタリング

### v0.52
- **システムエンジニア・管理者専用サイト更新ブログ**に10件ずつのページネーションを実装
- DirectoryTreeを折りたたみ式にし各ファイルへのリンクを追加
- ソース閲覧用ページ `/source/*` を追加しテキスト表示に対応

### v0.53
- 簡易的なログイン機能を追加
- `/login` ページと `/api/login` API でユーザー認証を実装

### v0.54
- 新着情報ページ `/news` と 店舗ブログ `/customer_blog` を追加
- ホームにヒーロー画像スライダーを導入
- ヘルプページ `/help` を追加しナビゲーションからアクセス可能に
- 排気量などで絞り込めるジャンル別ページ `/t/genre/*` を追加
- 店舗一覧 `/stores` を掲載し料金 `/pricing`、保険説明 `/insurance` を新設
- ご利用案内 `/beginner` と お問い合わせ `/contact` を整備
- 会社概要や外部送信規律、特商法、利用規約、プライバシーポリシーなど法定ページを追加

### v0.55
- トップページにFAQセクションを追加

### v0.56
- CSSスタイルガイドを追加しデザイン指針を共有
- 最近チェックした商品機能を実装
- アクセス集中時に一時ブロックする制限機能を導入し `/wait` ページへ誘導
- サイトリニューアルのお知らせを公開

### v0.57
- 人気の型番カルーセルのデザインをモダンに刷新

### v0.58
- 店舗ブログにカレンダーとタグ別ページを追加し、マニュアルブログと同じレイアウトに統一
- ホームセクションの構成を整理しレイアウトを改善
- FAQセクションをランダム10件表示に変更
- はじめてガイドバナーのサイズを調整
- 最近チェックした商品画像を正方形に統一
- **カスタマーブログ記事**にハッシュタグを表示

### v0.59
- 注目キーワードを最大7件表示し、最後に「もっと見る」リンクを追加
- "原付スクーター" など8種類のキーワードをブログのハッシュタグへ紐付け

### v0.60
- `/signup` をライト会員専用の登録導線として再設計し、MYP-DASH への自動ログインを実装
- ライト会員情報を保持するモックDB `lib/mockUserDb.ts` を追加し、ログインAPIと連携
- 登録時の入力バリデーションとフィードバックUIを整備

### v0.61
- 認証コード入力ページ `/register/auth` を追加し、本登録の2段階認証フローを導入
- サインアップAPIで認証コードを発行しAWS SESによるメール送信（ローカルはモック送信）に対応
- 認証コード検証API `/api/register/verify` を実装し、成功時にライト会員を作成するよう変更

### v0.62
- Amazon Cognito 連携の Flask バックエンドと連携するログインフローを整備
- `/auth/login`・`/auth/callback`・`/auth/logout`・`/api/me` エンドポイントを追加
- ヘッダーと `/login` `/mypage` の UI を Cognito セッションに対応させ、サインイン状態を表示
## 主要ディレクトリ
- `components/` - React コンポーネント群
- `pages/` - Next.js ページ
- `manual_for_system/` - 更新ブログや設計メモ
- `blog_for_custmor/` - 店舗向けブログ記事
- `data/` - FAQ などの静的データ
- `lib/` - 補助スクリプトやユーティリティ
- `styles/` - グローバル CSS
- `docs/` - プロジェクトドキュメント

## ご利用方法
1. **店舗を選ぶ** - 足立小台本店または三ノ輪店から出発店舗を選択します。
2. **ご予約** - 各車両ページのスケジュールを確認し、クレジットカードで予約します。変更やキャンセルはお問い合わせよりご連絡ください。
3. **ご来店** - 当日は10:00〜18:30の間に免許証とヘルメットをご持参の上ご来店ください。
4. **ご利用・返却** - 契約者ご本人のみが乗車・返却可能です。返却はガソリン満タンでお願いします。

より詳しい案内はサイト内の[ご利用案内ページ](http://54.238.143.220/beginner)をご覧ください。



## manual_for_system
サイトの更新情報や運用マニュアルをMarkdown形式で記録するディレクトリです。`/manual_for_system` 配下の `.md` ファイルはサイト上でも閲覧できます。


## ディレクトリ構成
本リポジトリの主なディレクトリは以下の通りです。

```
components/         React コンポーネント群
pages/              画面を構成する Next.js ページ
manual_for_system/  運用マニュアル・更新ブログ
blog_for_custmor/   店舗向けブログ記事
lib/                便利関数やユーティリティ
styles/             グローバル CSS
data/               静的データファイル
docs/               プロジェクトドキュメント
```

より詳しい説明は [docs/OVERVIEW.md](docs/OVERVIEW.md) を参照してください。

## 認証コード設計メモ

AWS上での本番運用を想定し、メールリンクとワンタイム認証コードを組み合わせた2段階登録を設計しています。

- **コード生成**: `lib/verificationCodeService.ts` で英数字6桁のコードを生成します。暗号学的に安全な `crypto.randomBytes` を利用し、24時間の有効期限と5回までの入力制限を設定しています。入力上限に達した場合はコードを失効させ、再度メールアドレスから発行し直す運用とします。
- **データストア**: 本番環境では DynamoDB テーブル `registration_verification_codes` を用意し、`PK = email`, `code`, `expiresAt`, `attempts` を保持します。TTL機能を有効化して24時間経過後に自動削除します。開発環境ではメモリ上のMapで代替しています。
- **メール送信**: `lib/verificationEmail.ts` がAWS SESへ送信処理を委譲します。`AWS_REGION` と `AWS_SES_SOURCE_EMAIL` を設定するとSESクライアントが作成され、本番用のHTML/テキストテンプレートで送信します。環境変数が未設定の場合はモック送信としてログ出力に切り替わります。
- **エンドポイント構成**:
  - `POST /api/signup` はメールアドレスを受け取り、重複登録を判定した上でコードを発行・送信し、`/register/auth?email=...` へ誘導するリンクを生成します。
  - `POST /api/register/verify` はメールアドレスとコードを検証し、成功時に `lib/mockUserDb.ts` を通じてライト会員を作成し、セッションクッキーを付与します。
- **再送運用**: 認証コードメールが届かない場合は `/signup` で再入力して再発行します。既存コードは上書きされ、最新のコードのみが有効になります。
- **監査と可観測性**: SESの送信結果はCloudWatch Logsへ出力し、DynamoDBテーブルには`attempts`フィールドで入力回数を保持します。異常な連続失敗はEventBridgeで通知する想定です。

これらの設計により、AWSを活用したセキュアな仮登録→本登録フローを維持しつつ、ローカル開発ではモック機構で簡易検証が可能です。
## 各ファイルの役割

- `components/BikeModelCarousel.tsx`  
  トップページなどでバイクの人気モデルを横スクロール表示するカルーセルコンポーネント。型定義したBikeItem配列を受け取り、画像とモデル名、バッジをカード形式で表示します。Swiperライブラリを使いスマホではスワイプ操作可能。リンク遷移やタイトル変更にも対応し、220pxの画像を統一、セクションに余白と影を付けたデザインです。初期表示ではフェードイン効果を設定でき、ユーザーに注目してもらいやすいUIです。
- `components/ChatBot.tsx`  
  FAQデータを基にカテゴリ選択と質問応答を行うReactコンポーネント。useStateで会話履歴とステップを管理し、回答が見つからない場合は自由入力モードに移行します。Tailwind CSSでUIを調整し、吹き出し形式で履歴をスクロール表示。将来のOpenAI連携を想定した仮の返答を返し、シンプルなカードUIでスマホ対応。チャット部分は独立して再利用も容易です。
- `components/DirectoryTree.tsx`
  ディレクトリの構造をリスト形式で表示するコンポーネント。manual_for_systemページのサイドバーで利用します。
- `components/CalendarWidget.tsx`
  現在月のカレンダーを表示する小さなウィジェットです。
- `components/ChatBotWidget.tsx`
  画面右下に固定表示されるボタンからChatBotを開閉するウィジェットです。

- `components/FaqAccordion.tsx`
  質問と回答をアコーディオン形式で表示するコンポーネント。FAQセクションで利用します。
- `components/Header.tsx`
  サイト共通のヘッダー。検索バーとナビゲーション、メニューの開閉を提供します。
- `components/HeroSlider.tsx`
  トップページで大きな画像を自動スライド表示するヒーロースライダーです。
- `components/HowToUse.tsx`
  予約から返却までの流れを3ステップで案内するセクション用コンポーネント。
- `components/MobileNav.tsx`
  スマホ向けの固定ボトムナビゲーション。ホームやレンタル状況、マイページへ素早く移動できます。
- `components/RecentlyViewed.tsx`
  最近閲覧した車両をlocalStorageから取得して一覧表示するウィジェット。

- `components/Footer.tsx`  
  ページ下部に配置するフッターコンポーネント。ブランド説明文、サイトポリシーやサービス案内、SNSリンクを3カラムで整え、ロゴとコピーライトも表示します。Tailwind CSSのグリッドとLink、react-iconsを利用してレスポンシブ対応。薄グレーの背景と区切り線でページの締めを演出し、各項目は余白を活かしスマホでは縦並びに変化します。紹介文の下に問い合わせリンクを置き、ブランドの安心感を伝えます。
- `pages/index.tsx`
  ホーム画面を構成するメインページ。トップバーでキャンペーンを告知し、ヘッダーには検索バーとナビゲーションを設置。背景画像を使ったヒーローセクションや特徴紹介グリッド、新着ブログカルーセル、ジャンル別アイテム、人気モデルカルーセルを順に配置したモダンなレイアウトです。Swiperによるスライド表示とアニメーションを活用し、BikeModelCarouselやFooterコンポーネントを再利用しています.
- `pages/chat.tsx`
  チャットサポート専用のページ。Headでタイトルを設定し、メイン領域にChatBotコンポーネントを配置するだけのシンプルな構成です。背景を薄いグレーにし中央に見出しを置くことで、ユーザーがFAQ検索を始めやすい雰囲気を作ります。将来的な履歴保存や認証との連携も想定され、アプリ内のサブページとして扱いやすく独自スタイルも追加可能です。
- `pages/login.tsx`
  ユーザー名とパスワードでログインする簡易フォームを提供します。成功時はトップページへ遷移します。
- `pages/wait.tsx`
  アクセス集中時に一時的な待機を促すページで、解除ボタンで制限を解除できます.
- `pages/_app.tsx`
  全ページ共通の設定をまとめ、グローバルCSSやChatBotWidgetを読み込みます。レイアウト拡張や状態管理の導入ポイントとなります.
- `pages/_document.tsx`  
  HTMLのテンプレートを定義するNext.jsのDocumentファイル。Headでは外部のアイコンフォントやスタイルシート、アニメーションライブラリを読み込み、body内でMainとNextScriptを配置します。ここで追加したリンクやスクリプトは全ページに一括適用され、SEO対策や外部ツール設定をまとめて管理するのに便利です。アプリ全体の共通HTML構造を担う重要なファイルで、他の設定もここで統一します。
- `pages/products/index.tsx`
  全てのバイク機種を一覧表示するためのページ。現在は準備中のメッセージのみ表示します。

- `pages/manual_for_system/index.tsx`  
  **システムエンジニア・管理者専用サイト更新ブログ**の一覧を生成するファイル。manual_for_systemディレクトリ内のMarkdownを読み込み、日付順に並べ替えて一覧ページを静的生成します。タイトルや抜粋を取得し、リンクをクリックすると詳細ページへ遷移。シンプルなカードデザインで更新日と要約を表示し、サイトの運用状況を把握できます。getStaticPropsを活用することでビルド時にデータを取り込み、表示速度が速い点も特徴です。
- `pages/manual_for_system/[slug].tsx`  
  MarkdownファイルをHTMLに変換して表示する個別記事ページ。getStaticPathsでパスを生成し、getStaticPropsで内容を読み込みrenderMarkdown関数でタグに変換します。各記事は静的にビルドされ、ロードが速くSEOにも有利。コンテンツの更新時は再ビルドするだけで反映されます。表示はシンプルなプロース拡張クラスを使い、スタイルを保ちながら安全にHTMLを埋め込んでいます。
- `styles/global.css`  
  全体の配色やフォントを定めるグローバルCSS。:rootにカラーバリエーションを設定し、テキスト、リンク、ボタン、カードなどの共通デザインを定義しています。余白やホバーアニメーションも組み込み、_app.tsxで読み込むことで全ページにスタイルを適用。今後の追加ページでも基本となるスタイル群です。カード内画像の幅やボタンの丸みまで統一し、デザインの再利用性を高めます。今後のブランドカラー変更にも対応可能です。
- `data/chatbot-faq.json`
  チャットボットで利用するFAQデータをJSON形式で管理。カテゴリごとにid、title、qaの配列を保持し、ChatBotコンポーネントから読み込まれて各質問の回答を返すための基礎情報となります。現在は静的ファイルとして簡易テスト用に置かれていますが、管理画面を用意すれば動的更新も可能な設計です。質問内容や回答文を増やすことでチャットボットの精度向上にもつながります。
- `data/bikes.json`
  バイクラインナップを一覧管理するJSONファイル。モデル名や画像に加えスペックや取扱店舗を記述しており、`lib/bikes.ts` から読み込まれます。将来的にデータベースへ移行する際のベースデータとして利用します。
- `lib/getDirTree.ts`
  指定パスからディレクトリ階層を取得するユーティリティ。DirectoryTreeコンポーネントから呼び出されます。
- `lib/bikes.ts`
  `data/bikes.json` を読み込んでバイクモデル一覧を返すユーティリティ。将来は DynamoDB などへの置き換えを想定しています。
- `lib/mockUserDb.ts`
  ライト会員のモックデータベース。メモリ上の Map でユーザーを保持し、初期アカウントのシード、登録、認証、一覧取得を提供します。`/api/signup` と `/api/login` から利用し、登録直後に自動でログインする仕組みを支えます。
- `lib/pendingRegistrations.ts`
  仮登録フォームで送信された「メールアドレス・お名前・パスワード・電話番号」を本登録完了まで保持するインメモリの待機レコード管理です。認証コード検証時に取り出し、`createLightMember` へ引き渡します。

## ライト会員登録のモックDB設計

- データ構造
- `LightMember` 型で `id`, `username?`, `email?`, `passwordHash?`, `createdAt`, `plan`, `phoneNumber?`, `registrationStatus` を保持します。`registrationStatus` は `'provisional' | 'full'` のいずれかで、仮登録と本登録を判別します。
  - `plan` はライト会員を示す固定値 `"ライトプラン"` を採用しています。
- 保存方式
  - 会員情報はIDをキーにした `Map<string, LightMember>` と、ユーザー名・メールアドレス用のインデックスMapでインメモリ管理します。Next.js のAPIルート内で共有され、簡易なテストやデモ用途を想定しています。
  - 起動直後に `adminuser` / `adminuser` のデフォルトアカウントを自動生成し、既存のログイン動作を維持します。
- 提供機能
  - `createLightMember` がバリデーション付きで新規会員を登録し（メールアドレスのみの登録も可）、`verifyLightMember` がログイン照合を行います。
  - `/api/signup` は仮登録時に入力された情報を一時保存し、認証コードメールを送信します。コード検証が成功すると仮登録として `registrationStatus: 'provisional'` の会員が生成されます。
- `lib/rateLimit.ts`
  APIやミドルウェアで使用する簡易メモリベースのレートリミッターを実装しています。
- `middleware.ts`
  IPごとのアクセス制御とmanual_for_systemディレクトリへのBasic認証を行うミドルウェアです。
- `manual_for_system/2025-06-30-site-update.md`  
  サイトの更新履歴を記録したMarkdownファイル。2025年6月30日時点の開発状況として、Next.js初期構築やトップページのカルーセル実装などを説明しています。Markdown形式のため履歴の閲覧や管理が容易で、プロジェクト初期の方針を振り返る資料としても役立ちます。今後の開発予定を追記していくことで進捗を追うドキュメントとしても利用され、履歴の共有でチーム全体の認識を統一します。
- `manual_for_system/2025-06-30-chatbot-design.md`
  チャットボット機能の設計メモをまとめたMarkdown。FAQカテゴリのボタン表示から自由入力へ遷移する流れやOpenAI API連携予定などを記述しています。試験実装時の注意点やデータファイルの配置場所も記録し、ブログ記事として公開することで社内外への進捗共有を兼ねます。開発意図を簡潔にメモして方針のブレを防ぐ役割を担い、今後のチャット機能拡張時に参照する基礎資料として残しています。
- `manual_for_system/2025-06-30-development-summary.md`
  開発状況のまとめを記したMarkdownファイルです。
- `manual_for_system/2025-06-30-search-suggest.md`
  サイト内検索のサジェスト機能検討メモです。
- `manual_for_system/2025-07-01-site-renewal.md`
  サイトリニューアルのお知らせを掲載したMarkdownファイル。2025年7月1日に更新し、旧サイトから順次移行する旨を告知しています。
- `manual_for_system/2025-07-01-css-style-guide.md`
  CSSスタイルガイドをまとめたドキュメントです。
- `manual_for_system/2025-07-01-ddos-protection.md`
  DDoS対策の方針を記したメモです。
- `manual_for_system/2025-07-01-development-summary.md`
  2025年7月1日時点の開発サマリをまとめています。
- `manual_for_system/2025-07-01-recently-viewed.md`
  最近チェックした商品機能についての設計ノートです。
- `manual_for_system/2025-07-02-development-summary.md`
  2025年7月2日の開発状況をまとめた記事です。
- `manual_for_system/2025-07-03-development-summary.md`
  2025年7月3日の開発状況をまとめた記事です。
- `manual_for_system/2025-07-04-api-document.md`
  サイト更新ブログ用 API の概要をまとめたドキュメントです。
- `blog_for_custmor/`
  店舗ブログ記事をMarkdownで管理するディレクトリです。各記事のフロントマターでは
  `title`, `date`, `tags` に加え `eyecatch`(アイキャッチ画像URL) を設定できます。
- `next.config.js`
  Next.jsの動作設定を記述するファイル。現状はreactStrictModeをfalseにした最小構成のみですが、今後画像ドメインの許可や環境変数の定義など、ビルドやランタイムの挙動を調整する際に利用します。
- `next-env.d.ts`  
  TypeScript用の宣言ファイルで、Next.jsが生成する型定義をまとめています。CSSモジュールの型やNext.js特有のグローバル型を含み、エディタの補完精度を高めます。通常は自動更新されますが、新しいファイル形式を追加した際は追記することで型エラーを防げます。プロジェクトの設定次第ではカスタムモジュール宣言も追記でき、型安全な開発を支える裏方的な存在です。変更時は再起動が必要です。
- `package.json`  
  プロジェクト管理に使用する設定ファイル。Next.jsやReact、Swiper、react-iconsなど依存ライブラリのバージョンを記述し、npm scriptsとしてdev・build・startコマンドを登録しています。プライベートフラグによりnpm公開はされず、今後依存追加やバージョン更新を行う際はここを編集しチームの環境を統一します。設定内容はGitで管理されているため、全員が同じ環境で作業できます。
- `tsconfig.json`  
  TypeScriptのコンパイル設定をまとめるファイル。ES2017ターゲットやモジュール解決方法、jsx設定などを定義し、strictモードは無効化。Next.js推奨のオプションをベースにインクリメンタルビルドやJSONモジュール読み込みを有効にしています。include/excludeを指定してnode_modulesを除外し、開発効率とビルド速度を向上させます。設定変更で型チェック厳格化も可能。
### 仮登録で必要となる入力項目

| 項目名 | キー | 形式 / 備考 |
| --- | --- | --- |
| メールアドレス | `email` | 有効なメールアドレス。既存会員と重複不可 |
| お名前 | `fullName` | 全角可。前後の空白は自動で除去 |
| パスワード | `password` | 6文字以上の半角英数字を推奨 |
| 電話番号 | `phoneNumber` | ハイフン無しで 10〜15 桁の数字に正規化され保存 |

入力内容は `docs/registration_parameters_sample.csv` に CSV 形式のサンプルを用意しています。`registration_type` 列で `provisional` を選択した行が仮登録に必要な最小セット、`full` 行が将来的に予定している本登録のフル項目例です。

## AWS連携例
ログイン機能を本番運用する場合、Amazon Cognito を使って認証やユーザープールを管理することができます。EC2 上のアプリから Cognito を利用すれば、パスワードリセットや多要素認証なども簡単に設定できます。

## 開発環境のセットアップ
1. Node.js 18系を推奨します。リポジトリをクローン後、依存パッケージをインストールします。
   ```bash
   npm install
   ```
2. 開発サーバーを起動するには以下を実行します。
   ```bash
   npm run dev
   ```
   ブラウザで `http://localhost:3000` を開くとアプリを確認できます。

## テストとLint
`npm test -- --passWithNoTests` と `npm run lint` を実行してコード品質を確認します。

AWS などでの本番運用時は Cognito を用いたユーザー認証にも対応可能です。
