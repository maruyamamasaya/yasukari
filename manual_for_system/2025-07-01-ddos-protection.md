---
title: "アクセス制限機能の導入"
date: "2025-07-01"
---

# アクセス制限機能の導入 (2025/07/01)

短時間に大量のアクセスが集中した場合や、同一ユーザーによるログイン失敗が続いた場合に、一時的にアクセスを制限する仕組みを追加しました。

## 制限条件

- 10秒間に50回を超えるページアクセス
- ログインに5回連続して失敗

上記いずれかを検知したIPアドレスは1分間、サイトの他ページへ遷移できません。アクセス時には `/wait` ページへリダイレクトされます。

## 待機ページ

`/wait` では制限理由を表示し、問い合わせ先メールアドレスのみ記載しています。2025年7月の更新で、3つのボタンから正しいものを選ぶと即時解除できる仕組みを試験導入しました。

## 実装概要

- `middleware.ts` で全ページへのアクセス回数を監視
- `pages/api/login.ts` でログイン失敗回数をカウント
- どちらも `lib/rateLimit.ts` の簡易メモリストアで状態管理

今後必要に応じて永続ストレージへの記録や解除処理を拡張していきます。

## モニタリングページ

アクセス状況の一覧は `/monitor` から確認できます。`pages/monitor.tsx` が 1 秒ごとに `/api/monitor` を呼び出し、IP アドレスごとのアクセス回数やブロック状態をテーブル形式で表示します。開発中のため保守用の簡易画面ですが、管理者はブラウザでこのページを開くことでリアルタイムの制限状況を把握できます。

